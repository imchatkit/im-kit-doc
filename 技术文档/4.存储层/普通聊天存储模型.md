## 数据库选型:

MySQL



## 消息入库服务

从MQ中消费消息,然后保存至数据库. 目的是防止消息量过大写爆MySQL数据库.
Websocket网关接收到消息,在网关中先保存至MQ(同步刷盘), 此服务从MQ中拉取数据再保存至MySQL.
来解决节假日等消息收发量突然增大的洪峰.

支持集群部署

## 先保存MQ,再写入MySQL

**优点:**

- MQ写入速度比MySQL要快很多
- 扛高并发:节假日等消息收发量突然增大时,有削峰填谷作用
- 防写爆MySQL:收发量突然增大时,MySQL处理速度跟不上Websocket网关收到的消息
- 低延迟响应:如果Websocket直接同步保存MySQL,MySQL如果此时已经达到写入瓶颈,消息发送方将会一直等待保存数据库后才会返回消息成功
- 可靠性:直接写入是非常依赖DB的，如果一旦DB出现故障,如MySQL的IO读写性能出现瓶颈，则Websocket的消息无法同步落盘DB会导致线上故障。

**缺点**

- 造成带宽和服务器资源的浪费
- 延迟:MQ异步保存至数据库会有延迟的情况,此时有客户端查询离线消息,将无法查询到

参考:

rocketm性能测试方案&压测&选型&结论: [rocketmq-2：性能测试方案&压测&选型&结论-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1456397)

## 更好的方案

使用分布式数据库,如:**TiDB**

但考虑到部署成本,运维成本,本项目没有使用TIDB,如果你有需要可以自行部署TiDB,
可以将MySQL无缝迁移至TiDB

## 功能规划