# 消息引用功能方案设计

更新记录:
```
2024.11.25 初始创建
```

## 一、功能概述

消息引用功能允许用户在发送消息时引用(回复)之前的某条消息,形成关联关系,在界面上以特殊方式展示。

## 二、消息格式

### 2.1 发送引用消息

```json
{
    "request": 1,  // 单聊
    "msgType": 9,  // 引用消息类型
    "localId": "quote-msg-uuid", 
    "room": 123456,
    "msgText": "这是回复的内容",
    "payload": {
        "quote": {
            "msgId": "1858689625873399809",  // 被引用消息的ID
            "from": "1858679205636755457",   // 被引用消息的发送者
            "msgType": 1,                     // 被引用消息的类型
            "msgText": "原始消息内容",        // 被引用消息的文本内容
            "timestamp": 1732501048300        // 被引用消息的时间戳
        },
        "extras": {} // 可选的扩展字段
    }
}
```

### 2.2 接收引用消息

```json
{
    "msgType": 9,
    "localId": "quote-msg-uuid",
    "msgText": "这是回复的内容", 
    "room": "1858689382414958593",
    "payload": {
        "quote": {
            "msgId": "1858689625873399809",
            "from": "1858679205636755457",
            "msgType": 1,
            "msgText": "原始消息内容",
            "timestamp": 1732501048300
        }
    },
    "response": 2,
    "from": "1858679205636755457",
    "msgId": "1858689625873399810",
    "roomSeq": "3",
    "timestamp": "1731981114242"
}
```

## 三、数据库设计

### 3.1 消息引用关系表(im_message_quote)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| fk_msg_id | bigint | 引用消息ID(外键) |
| fk_quoted_msg_id | bigint | 被引用消息ID(外键) |
| fk_room_id | bigint | 房间ID |
| create_time | bigint | 创建时间 |

### 3.2 索引设计

```sql
-- 主键索引
PRIMARY KEY (id),

-- 消息ID索引
INDEX idx_msg_id (fk_msg_id),

-- 被引用消息ID索引 
INDEX idx_quoted_msg_id (fk_quoted_msg_id),

-- 房间ID索引
INDEX idx_room_id (fk_room_id)
```

## 四、业务规则

1. 引用消息必须在同一个房间内
2. 被引用的消息类型支持:
   - 文本消息(1)
   - 图片消息(3) 
   - 语音消息(2)
   - 文件消息(6)
   - 视频消息(8)

3. 引用链最大深度限制为1(不支持引用另一条引用消息)
4. 如果被引用的消息被删除,引用消息仍然保留,但显示"原消息已删除"
5. 被引用消息的内容长度限制:
   - 文本消息: 显示前100字符
   - 图片/视频: 显示缩略图
   - 文件: 显示文件名
   - 语音: 显示语音时长

## 五、客户端展示

1. 引用消息气泡布局:
```
+------------------------+
| > 原消息(被引用部分)    |
| ------------------    |
| 新消息内容             |
+------------------------+
```

2. 点击被引用部分可跳转到原始消息位置

3. 被引用消息预览规则:
   - 文本: 显示前100字符,超出显示...
   - 图片: 显示小尺寸预览图
   - 语音: 显示语音图标+时长
   - 文件: 显示文件图标+文件名
   - 视频: 显示视频首帧预览图

## 六、性能考虑

1. 引用关系表建立合适的索引以提升查询性能

2. 消息内容查询优化:
   - 被引用消息内容可选择性缓存
   - 可以增加被引用次数计数,对高频被引用消息优先缓存

3. 限制单条消息被引用的最大次数,避免滥用

4. 定期清理已删除原始消息的引用关系记录 